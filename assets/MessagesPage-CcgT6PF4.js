const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CRZ081Ij.js","assets/index-BzcMdIz7.css"])))=>i.map(i=>d[i]);
import{r,j as e,A as we,b as ne,s as D,d as Le,D as ca,e as da,u as ma,a as ua,S as ye,L as pa,_ as fa}from"./index-CRZ081Ij.js";import{C as Ee}from"./ConfirmationModal-DvEFkCZh.js";import{A as Je}from"./AppointmentDetailsOverlay-BLbRgaD2.js";import{E as Ge}from"./EmptyState-C-Wjzl4p.js";const ha=s=>{const d=new Date(s),m=Math.floor((new Date().getTime()-d.getTime())/1e3),p=Math.floor(m/60),y=Math.floor(p/60),f=Math.floor(y/24);return m<60?"ora":p<60?`${p}m fa`:y<24?`${y}h fa`:f===1?"ieri":f<7?`${f} giorni fa`:d.toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"})},ga=r.memo(function({chats:d,selectedChatId:o,onChatSelect:m,onRequestDeleteChat:p}){const y=(f,A)=>{f.stopPropagation(),p(A)};return e.jsxs("div",{className:"chat-list",children:[e.jsxs("div",{className:"chat-list-header",children:[e.jsx("h2",{className:"chat-list-title",children:"MESSAGGI"}),e.jsxs("span",{className:"chat-count",children:[d.length," conversazioni"]})]}),e.jsx("div",{className:"chat-list-items",children:d.length===0?e.jsxs("div",{className:"empty-chat-list",children:[e.jsx("div",{className:"empty-chat-icon",children:"💬"}),e.jsx("p",{className:"empty-chat-text",children:"Nessuna conversazione ancora"})]}):d.map(f=>e.jsxs("div",{className:`chat-item ${o===f.id?"active":""}`,onClick:()=>m(f.id),children:[e.jsx("div",{className:"chat-avatar",children:e.jsx(we,{src:f.participant.avatar,name:f.participant.name,alt:`Avatar di ${f.participant.name}`,size:"sm",variant:"default"})}),e.jsxs("div",{className:"chat-content",children:[e.jsxs("div",{className:"chat-header",children:[e.jsx("h3",{className:"chat-list-participant-name",children:f.participant.name}),e.jsxs("div",{className:"chat-header-actions",children:[e.jsx("span",{className:"chat-timestamp",children:ha(f.timestamp)}),e.jsx("button",{className:"chat-delete-btn",onClick:A=>y(A,{id:f.id,participant:{name:f.participant.name}}),title:"Elimina conversazione","aria-label":"Elimina conversazione",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("polyline",{points:"3,6 5,6 21,6"}),e.jsx("path",{d:"m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"})]})})]})]}),e.jsxs("div",{className:"chat-preview",children:[e.jsx("p",{className:"chat-last-message",children:f.lastMessage}),f.unreadCount>0&&e.jsx("span",{className:"chat-unread-count",children:f.unreadCount})]})]})]},f.id))})]})}),pe=(s,d)=>{try{const o=JSON.parse(s);if(o.type==="booking_request"&&o.booking_id)return d?"Richiesta inviata":"Richiesta ricevuta";if(o.type==="appointment_scheduled"&&o.booking_id)return d?"Appuntamento programmato":"Appuntamento confermato"}catch{}return s};function xa(){const{user:s}=ne(),[d,o]=r.useState([]),[m,p]=r.useState([]),[y,f]=r.useState(!0),[A,M]=r.useState(null),E=r.useCallback(async()=>{if(s)try{f(!0),M(null);const{data:h,error:k}=await D.from("user_conversation_deletions").select("participant_id, deleted_at").eq("user_id",s.id);k&&k.code;const u=new Map(h?.map(i=>[i.participant_id,i.deleted_at])||[]),{data:x,error:S}=await D.from("messages").select(`
          id,
          sender_id,
          receiver_id,
          content,
          created_at,
          is_read
        `).or(`sender_id.eq.${s.id},receiver_id.eq.${s.id}`).is("deleted_at",null).order("created_at",{ascending:!1});if(S)throw S;const O=x;if(O.length===0){o([]),p([]);return}const T=O.filter(i=>{const _=i.sender_id===s.id?i.receiver_id:i.sender_id,t=u.get(_);return t?new Date(i.created_at)>new Date(t):!0});if(T.length===0){o([]),p([]);return}const b=new Set;b.add(s.id),T.forEach(i=>{b.add(i.sender_id),b.add(i.receiver_id)});const N=new Map;if(b.size>0)try{const{data:i,error:_}=await D.from("profiles").select("user_id, full_name, username, avatar_url, profile_type").in("user_id",Array.from(b));!_&&i&&i.forEach(t=>{N.set(t.user_id,t)})}catch{}const c=new Map;T.forEach(i=>{const _=i.sender_id===s.id,t=_?i.receiver_id:i.sender_id,w=[s.id,t].sort(),H=`${w[0]}__${w[1]}`;if(!c.has(H)){const Y=T.filter(G=>G.sender_id===t&&G.receiver_id===s.id&&!G.is_read).length,v=N.get(t),I=v?.profile_type==="client"?v?.full_name||`User ${t.slice(0,8)}`:v?.username||v?.full_name||`User ${t.slice(0,8)}`;c.set(H,{id:H,participant:{user_id:t,name:I,username:v?.username||"",avatar:v?.avatar_url||null},lastMessage:pe(i.content,_),timestamp:i.created_at,unreadCount:Y,isFromCurrentUser:_})}});const g=Array.from(c.values()).sort((i,_)=>new Date(_.timestamp).getTime()-new Date(i.timestamp).getTime());o(g);const j=T.map(i=>{const _=N.get(i.sender_id),t=N.get(i.receiver_id);return{id:i.id,sender_id:i.sender_id,receiver_id:i.receiver_id,content:i.content,created_at:i.created_at,is_read:i.is_read,deleted_at:null,sender:{user_id:i.sender_id,full_name:_?.profile_type==="client"?_?.full_name||`User ${i.sender_id.slice(0,8)}`:_?.username||_?.full_name||`User ${i.sender_id.slice(0,8)}`,username:_?.username||"",avatar_url:_?.avatar_url||null},receiver:{user_id:i.receiver_id,full_name:t?.profile_type==="client"?t?.full_name||`User ${i.receiver_id.slice(0,8)}`:t?.username||t?.full_name||`User ${i.receiver_id.slice(0,8)}`,username:t?.username||"",avatar_url:t?.avatar_url||null}}});p(j)}catch(h){M(h instanceof Error?h.message:"Failed to fetch messages")}finally{f(!1)}},[s]),R=r.useCallback(async h=>{if(!s)return[];try{const{data:k,error:u}=await D.from("user_conversation_deletions").select("participant_id, deleted_at").eq("user_id",s.id).eq("participant_id",h);u&&u.code;let x=null;k&&k.length>0&&(x=k[0].deleted_at);let S=D.from("messages").select(`
          id,
          sender_id,
          receiver_id,
          content,
          created_at,
          is_read
        `).or(`and(sender_id.eq.${s?.id},receiver_id.eq.${h}),and(sender_id.eq.${h},receiver_id.eq.${s?.id})`).is("deleted_at",null).order("created_at",{ascending:!0});x&&(S=S.gt("created_at",x));const{data:O,error:T}=await S;if(T)throw T;const b=O;if(b.length===0)return[];const N=[s.id,h],c=new Map;try{const{data:j,error:i}=await D.from("profiles").select("user_id, full_name, username, avatar_url, profile_type").in("user_id",N);!i&&j&&j.forEach(_=>{c.set(_.user_id,_)})}catch{}return b.map(j=>{const i=c.get(j.sender_id),_=c.get(j.receiver_id);return{id:j.id,sender_id:j.sender_id,receiver_id:j.receiver_id,content:j.content,created_at:j.created_at,is_read:j.is_read,deleted_at:null,sender:{user_id:j.sender_id,full_name:i?.profile_type==="client"?i?.full_name||`User ${j.sender_id.slice(0,8)}`:i?.username||i?.full_name||`User ${j.sender_id.slice(0,8)}`,username:i?.username||"",avatar_url:i?.avatar_url||null},receiver:{user_id:j.receiver_id,full_name:_?.profile_type==="client"?_?.full_name||`User ${j.receiver_id.slice(0,8)}`:_?.username||_?.full_name||`User ${j.receiver_id.slice(0,8)}`,username:_?.username||"",avatar_url:_?.avatar_url||null}}})}catch{return[]}},[s]),C=r.useCallback(async(h,k)=>{if(s)try{const u=[s.id,h].sort(),x=`${u[0]}__${u[1]}`;let S=!1;if(o(O=>O.find(b=>b.id===x)?O.map(b=>b.id===x?{...b,lastMessage:pe(k,!0),timestamp:new Date().toISOString(),isFromCurrentUser:!0}:b).sort((b,N)=>new Date(N.timestamp).getTime()-new Date(b.timestamp).getTime()):(S=!0,O)),S){let O=null;try{const{data:b,error:N}=await D.from("profiles").select("user_id, full_name, username, avatar_url, profile_type").eq("user_id",h).single();!N&&b&&(O=b)}catch{}const T={id:x,participant:{user_id:h,name:O?.profile_type==="client"?O?.full_name||`User ${h.slice(0,8)}`:O?.username||O?.full_name||`User ${h.slice(0,8)}`,username:O?.username||"",avatar:O?.avatar_url||null},lastMessage:pe(k,!0),timestamp:new Date().toISOString(),unreadCount:0,isFromCurrentUser:!0};o(b=>[T,...b].sort((N,c)=>new Date(c.timestamp).getTime()-new Date(N.timestamp).getTime()))}}catch{}},[s]),$=r.useCallback(async(h,k)=>{if(!s||!k.trim())return!1;try{const{data:u,error:x}=await D.from("messages").insert([{sender_id:s.id,receiver_id:h,content:k.trim()}]).select();if(x)throw x;return u&&u.length>0&&await D.channel("global-messages").send({type:"broadcast",event:"new_message",payload:u[0]}),await C(h,k.trim()),!0}catch(u){return M(u instanceof Error?u.message:"Failed to send message"),!1}},[s,C]),B=async h=>{if(s)try{const{error:k}=await D.from("messages").update({is_read:!0}).eq("sender_id",h).eq("receiver_id",s.id).eq("is_read",!1);if(k)throw k;o(u=>u.map(x=>x.participant.user_id===h?{...x,unreadCount:0}:x))}catch{}},z=async h=>{if(s)try{const{error:k}=await D.from("user_conversation_deletions").upsert({user_id:s.id,participant_id:h,deleted_at:new Date().toISOString()},{onConflict:"user_id,participant_id"});if(k)throw k;o(u=>u.filter(x=>x.participant.user_id!==h))}catch(k){M(k instanceof Error?k.message:"Failed to delete conversation")}},l=()=>d.reduce((h,k)=>h+k.unreadCount,0);return r.useEffect(()=>{if(!s)return;const h=D.channel("global-messages").on("broadcast",{event:"new_message"},async k=>{const u=k.payload;if(!(!u||u.receiver_id!==s.id))try{let x=null;try{const{data:N,error:c}=await D.from("profiles").select("user_id, full_name, username, avatar_url, profile_type").eq("user_id",u.sender_id).single();!c&&N&&(x=N)}catch{}let S=null;try{const{data:N,error:c}=await D.from("profiles").select("user_id, full_name, username, avatar_url, profile_type").eq("user_id",s.id).single();!c&&N&&(S=N)}catch{}const O={id:u.id,sender_id:u.sender_id,receiver_id:u.receiver_id,content:u.content,created_at:u.created_at,is_read:!1,deleted_at:null,sender:{user_id:u.sender_id,full_name:x?.profile_type==="client"?x?.full_name||`User ${u.sender_id.slice(0,8)}`:x?.username||x?.full_name||`User ${u.sender_id.slice(0,8)}`,username:x?.username||"",avatar_url:x?.avatar_url||null},receiver:{user_id:u.receiver_id,full_name:S?.profile_type==="client"?S?.full_name||`User ${u.receiver_id.slice(0,8)}`:S?.username||S?.full_name||`User ${u.receiver_id.slice(0,8)}`,username:S?.username||"",avatar_url:S?.avatar_url||null}};p(N=>[...N,O]);const T=[s.id,u.sender_id].sort(),b=`${T[0]}__${T[1]}`;o(N=>N.find(g=>g.id===b)?N.map(g=>g.id===b?{...g,lastMessage:pe(u.content,!1),timestamp:u.created_at,isFromCurrentUser:!1,unreadCount:g.unreadCount+1}:g).sort((g,j)=>new Date(j.timestamp).getTime()-new Date(g.timestamp).getTime()):[{id:b,participant:{user_id:u.sender_id,name:x?.profile_type==="client"?x?.full_name||`User ${u.sender_id.slice(0,8)}`:x?.username||x?.full_name||`User ${u.sender_id.slice(0,8)}`,username:x?.username||"",avatar:x?.avatar_url||null},lastMessage:pe(u.content,!1),timestamp:u.created_at,unreadCount:1,isFromCurrentUser:!1},...N].sort((j,i)=>new Date(i.timestamp).getTime()-new Date(j.timestamp).getTime()))}catch{}}).subscribe();return()=>{D.removeChannel(h)}},[s]),r.useEffect(()=>{E()},[E]),{conversations:d,messages:m,loading:y,error:A,sendMessage:$,fetchConversationMessages:R,markConversationAsRead:B,deleteConversation:z,getUnreadCount:l,refreshConversations:E}}function Ke({bookingId:s,isFromCurrentUser:d,timestamp:o,mode:m="message",participantName:p,cardType:y,refreshTrigger:f,onBookingUpdated:A,showParticipants:M=!1}){const{user:E,profile:R}=ne(),[C,$]=r.useState("pending"),[B,z]=r.useState(!0),[l,h]=r.useState(null),[k,u]=r.useState(!1),x=async()=>{if(!E||!s){z(!1);return}try{const{data:i,error:_}=await D.from("bookings").select("*").eq("id",s).maybeSingle();_?($("pending"),h(null)):i&&($(i.status||"pending"),h({subject:i.subject,tattoo_style:i.tattoo_style,body_area:i.body_area,size_category:i.size_category,color_preferences:i.color_preferences,meaning:i.meaning,budget_min:i.budget_min,budget_max:i.budget_max,reference_images:i.reference_images,created_at:i.created_at,appointment_date:i.appointment_date,appointment_duration:i.appointment_duration,deposit_amount:i.deposit_amount,total_amount:i.total_amount,artist_notes:i.artist_notes}))}catch{$("pending"),h(null)}finally{z(!1)}};r.useEffect(()=>{x()},[s,E,f,x]);const S=i=>new Date(i).toLocaleString("it-IT",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),O=()=>l?l.budget_min&&l.budget_max?`€${l.budget_min} - €${l.budget_max}`:l.budget_min?`da €${l.budget_min}`:l.budget_max?`fino a €${l.budget_max}`:"Budget da definire":"Budget da definire",T=()=>l?.appointment_date?new Date(l.appointment_date).toLocaleDateString("it-IT",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"",b=()=>{if(!l?.appointment_duration)return"";const i=Math.floor(l.appointment_duration/60),_=l.appointment_duration%60;return i>0&&_>0?`${i}h ${_}min`:i>0?`${i}h`:`${_}min`},N=y==="appointment"||y!=="request"&&!!(l?.appointment_date||l?.deposit_amount),c=()=>{m==="appointment"&&u(!0)},g=()=>{if(B)return e.jsx("span",{className:"status-badge pending",children:"Caricamento..."});if(!N)switch(C){case"pending":return e.jsx("span",{className:"status-badge pending",children:"In attesa"});case"scheduled":case"rescheduled":case"completed":return e.jsx("span",{className:"status-badge accepted",children:"Accettata"});case"expired":return e.jsx("span",{className:"status-badge expired",children:"Scaduta"});case"cancelled":return null;default:return null}switch(C){case"pending":return e.jsx("span",{className:"status-badge pending",children:"In attesa"});case"expired":return e.jsx("span",{className:"status-badge expired",children:"Scaduta"});case"accepted":return e.jsx("span",{className:"status-badge accepted",children:"Accettata"});case"declined":return e.jsx("span",{className:"status-badge declined",children:"Rifiutata"});case"scheduled":return e.jsx("span",{className:"status-badge accepted",children:"Programmato"});case"rescheduled":return e.jsx("span",{className:"status-badge accepted",children:"Riprogrammato"});case"completed":return e.jsx("span",{className:"status-badge accepted",children:"Completato"});case"cancelled":return e.jsx("span",{className:"status-badge declined",children:"Cancellato"});default:return e.jsx("span",{className:"status-badge pending",children:"In attesa"})}},j=e.jsxs("div",{className:`appointment-card ${m==="appointment"?"clickable":""}`,onClick:c,children:[e.jsxs("div",{className:"booking-header",children:[e.jsxs("div",{className:"booking-title-container",children:[e.jsxs("div",{className:"booking-title",children:[e.jsx("span",{className:"booking-icon",children:N?"📅":"📝"}),e.jsx("h4",{children:N?"Appuntamento":"Richiesta Tatuaggio"})]}),e.jsx("div",{className:"status-badge-mobile",children:g()})]}),e.jsx("div",{className:"status-badge-desktop",children:g()})]}),e.jsxs("div",{className:"booking-content",children:[m==="appointment"&&p&&e.jsxs("div",{className:"booking-field",children:[e.jsxs("span",{className:"field-label",children:[R?.profile_type==="artist"?"Cliente":"Artista",":"]}),e.jsx("span",{className:"field-value",children:p})]}),l&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Soggetto:"}),e.jsx("span",{className:"field-value",children:l.subject})]}),l&&e.jsx(e.Fragment,{children:N?e.jsxs(e.Fragment,{children:[l.appointment_date&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Data e Ora:"}),e.jsx("span",{className:"field-value",children:T()})]}),l.appointment_duration&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Durata:"}),e.jsx("span",{className:"field-value",children:b()})]}),l.total_amount&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Prezzo Totale:"}),e.jsxs("span",{className:"field-value budget",children:["€",l.total_amount]})]}),l.deposit_amount&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Acconto:"}),e.jsxs("span",{className:"field-value budget deposit",children:["€",l.deposit_amount]})]}),l.artist_notes&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Note Artista:"}),e.jsx("span",{className:"field-value",children:l.artist_notes})]})]}):e.jsxs(e.Fragment,{children:[l.tattoo_style&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Stile:"}),e.jsx("span",{className:"field-value",children:l.tattoo_style})]}),l.body_area&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Zona:"}),e.jsx("span",{className:"field-value",children:l.body_area})]}),l.size_category&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Dimensioni:"}),e.jsx("span",{className:"field-value",children:l.size_category})]}),l.color_preferences&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Colore:"}),e.jsx("span",{className:"field-value",children:l.color_preferences})]}),l.meaning&&e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Significato:"}),e.jsx("span",{className:"field-value",children:l.meaning})]}),l.reference_images&&l.reference_images.length>0&&e.jsxs("div",{className:"booking-field reference-images",children:[e.jsx("span",{className:"field-label",children:"Riferimenti:"}),e.jsx("div",{className:"reference-images-container",children:l.reference_images.map((i,_)=>e.jsx("div",{className:"reference-image",children:e.jsx("img",{src:i,alt:`Riferimento ${_+1}`,className:"reference-image-preview",onClick:()=>window.open(i,"_blank")})},_))})]}),e.jsxs("div",{className:"booking-field",children:[e.jsx("span",{className:"field-label",children:"Budget:"}),e.jsx("span",{className:"field-value budget",children:O()})]})]})})]}),e.jsx("div",{className:"booking-footer",children:e.jsx("span",{className:"booking-time",children:N?`Appuntamento creato il ${S(o)}`:`Richiesta creata il ${S(o)}`})})]});return m==="appointment"?e.jsxs(e.Fragment,{children:[j,e.jsx(Je,{isOpen:k,onClose:()=>u(!1),userType:R?.profile_type==="artist"?"artist":"client",artistName:R?.profile_type==="client"?p:void 0,clientName:R?.profile_type==="artist"?p:void 0,bookingId:s,showParticipants:M,onBookingUpdated:()=>{x(),A&&A()}})]}):e.jsx("div",{className:`message ${d?"sent":"received"}`,children:j})}const va=(s,d)=>({pending:{client:{text:"RICHIESTA INVIATA",icon:"⏳",color:"warning"},artist:{text:"RICHIESTA RICEVUTA",icon:"📬",color:"info"}},expired:{client:{text:"RICHIESTA SCADUTA",icon:"⏰",color:"muted"},artist:{text:"RICHIESTA SCADUTA",icon:"⏰",color:"muted"}},scheduled:{client:{text:"APPUNTAMENTO PROGRAMMATO",icon:"✅",color:"success"},artist:{text:"APPUNTAMENTO PROGRAMMATO",icon:"✅",color:"success"}},rescheduled:{client:{text:"APPUNTAMENTO MODIFICATO",icon:"🔄",color:"info"},artist:{text:"APPUNTAMENTO MODIFICATO",icon:"🔄",color:"info"}},cancelled:{client:{text:"APPUNTAMENTO ANNULLATO",icon:"🚫",color:"error"},artist:{text:"APPUNTAMENTO ANNULLATO",icon:"🚫",color:"error"}},completed:{client:{text:"TATTOO COMPLETATO",icon:"🎉",color:"success"},artist:{text:"TATTOO COMPLETATO",icon:"🎉",color:"success"}}})[s][d];function Ze({status:s,userType:d,artistName:o,clientName:m,artistId:p,currentUserId:y,bookingId:f,onBookingUpdated:A,showParticipants:M=!1}){const[E,R]=r.useState(!1),C=va(s,d);if(s==="pending"&&d==="artist")return null;const $=()=>{(s==="scheduled"||s==="rescheduled"||s==="pending"||s==="cancelled"||s==="completed")&&R(!0)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`booking-progress-tracker ${C.color}`,children:e.jsxs("div",{className:`progress-content ${s==="scheduled"||s==="rescheduled"||s==="pending"||s==="cancelled"||s==="completed"?"clickable":""}`,onClick:$,children:[e.jsx("span",{className:"progress-icon",children:C.icon}),e.jsx("span",{className:"progress-text",children:C.text})]})}),e.jsx(Je,{isOpen:E,onClose:()=>R(!1),userType:d,artistName:o,clientName:m,artistId:p,currentUserId:y,bookingId:f,showParticipants:M,onBookingUpdated:A})]})}function Qe(s){const{user:d,profile:o}=ne(),[m,p]=r.useState(null),[y,f]=r.useState(!1),[A,M]=r.useState(null),E=r.useCallback(async()=>{if(!d||!s||!o){p(null);return}f(!0),M(null);try{const{data:z,error:l}=await D.from("bookings").select("*").or(`and(client_id.eq.${d.id},artist_id.eq.${s}),and(client_id.eq.${s},artist_id.eq.${d.id})`).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(l)throw l;p(z||null)}catch(z){M(z instanceof Error?z.message:"Errore nel caricamento dello stato booking"),p(null)}finally{f(!1)}},[d,s,o]);r.useEffect(()=>{s?E():p(null)},[E,s]);const R=r.useCallback(async()=>{await E()},[E]),C=!!(m&&!["expired","cancelled"].includes(m.status)),$=!!(m&&!["expired"].includes(m.status)&&!(m.status==="completed"&&m.appointment_date&&new Date(m.appointment_date).getTime()<Date.now()-1440*60*1e3)&&!(m.status==="cancelled"&&new Date(m.updated_at).getTime()<Date.now()-1440*60*1e3)),B=!($&&(m?.status==="cancelled"||m?.status==="completed"))&&(!C||!$||o?.profile_type==="artist"&&m?.status==="pending");return{bookingData:m,loading:y,error:A,refreshBookingStatus:R,hasActiveBooking:C,showProgressTracker:$,showPinnedAction:B}}const _a=(s,d={})=>{const{retries:o=1,delay:m=100,behavior:p="auto"}=d;if(!s)return;const y=s.closest(".messages-page.mobile.conversation")!==null,A=s.lastElementChild?.querySelector(".booking-request-card")!==null;Ve(s,y,A,p),o>0&&setTimeout(()=>{const M=s.scrollTop,E=s.scrollHeight-s.clientHeight;Math.abs(M-E)>10&&Ve(s,y,A,p)},m)},Ve=(s,d,o,m)=>{const p=s.lastElementChild;if(d)if(o&&p)p.scrollIntoView({behavior:m,block:"end",inline:"nearest"});else{const y=s.querySelector("#messages-bottom");y?y.scrollIntoView({behavior:m,block:"start",inline:"nearest"}):p?p.scrollIntoView({behavior:m,block:"end"}):s.scrollTop=s.scrollHeight}else s.scrollTop=s.scrollHeight},Xe=s=>(d={})=>{s.current&&requestAnimationFrame(()=>{setTimeout(()=>{s.current&&_a(s.current,d)},d.delay||100)})},ja=s=>{try{const d=JSON.parse(s);if((d.type==="booking_request"||d.type==="appointment_scheduled")&&d.booking_id)return{booking_id:d.booking_id,message_type:d.type}}catch{return null}return null};function ba({participantId:s,participantName:d,onOpenBookingRequest:o,onOpenArtistAppointment:m}){const{user:p,profile:y}=ne();if(!p||!y||!s)return null;const f=y.profile_type==="artist",A=()=>{if(f){m&&m(s,d);return}o&&o(s)},M=f?"📅":"📝",E=f?"FISSA APPUNTAMENTO":"INVIA UNA RICHIESTA";return e.jsxs("button",{className:"pinned-action-btn",onClick:A,children:[e.jsx("span",{className:"progress-icon",children:M}),e.jsx("span",{className:"progress-text",children:E})]})}function Na({chat:s,onRequestDeleteChat:d,sendMessage:o,fetchConversationMessages:m,hideHeaderAndInput:p=!1,onOpenBookingRequest:y,onOpenArtistAppointment:f,onBookingStatusRefresh:A,onMessagesRefresh:M,refreshTrigger:E,onBookingUpdated:R}){const{user:C,profile:$}=ne(),[B,z]=r.useState(""),[l,h]=r.useState([]),[k,u]=r.useState(!1),x=r.useRef(null),S=r.useRef(null),O=r.useRef(null),T=r.useCallback(v=>{if(!C)return null;const[I,G]=v.split("__");return I===C.id?G:I},[C]),b=r.useCallback(Xe(x),[]),N=s?T(s.id):null,{bookingData:c,showProgressTracker:g,showPinnedAction:j,refreshBookingStatus:i}=Qe(N);r.useEffect(()=>{A&&A(i)},[i,A]),r.useEffect(()=>{if(x.current)return S.current=new ResizeObserver(()=>{const v=x.current?.closest(".messages-page.mobile.conversation")!==null,I=x.current?.lastElementChild?.querySelector(".booking-request-card")!==null;b({retries:1,delay:v&&I?200:100})}),S.current.observe(x.current),()=>{S.current&&S.current.disconnect()}},[b]),r.useEffect(()=>{M&&s&&M(async()=>{if(!s||!m)return;const I=T(s.id);if(I)try{const se=(await m(I)).map(K=>({id:K.id,content:K.content,timestamp:K.created_at,isFromCurrentUser:K.sender_id===C?.id}));h(se),b({delay:150})}catch{}})},[M,s?.id,C?.id,m,T,b]),r.useEffect(()=>{if(!s){h([]),z(""),u(!1),O.current=null;return}const v=O.current!==s.id;v&&(h([]),z(""),u(!0),x.current&&(x.current.scrollTop=0),O.current=s.id);const I=W=>{if(!C)return null;const[q,X]=W.split("__");return q===C.id?X:q},G=async(W=!0)=>{if(!s||!m)return;const q=I(s.id);if(q){W&&u(!0);try{const ee=(await m(q)).map(L=>({id:L.id,content:L.content,timestamp:L.created_at,isFromCurrentUser:L.sender_id===C?.id}));h(L=>JSON.stringify(L)!==JSON.stringify(ee)?(requestAnimationFrame(()=>{setTimeout(()=>b(),150)}),ee):L)}catch{h([])}finally{W&&u(!1)}}},se=v;setTimeout(()=>{G(se)},v?50:0),b({delay:200});const K=I(s.id);if(!C||!K)return;const le=D.channel("global-messages").on("broadcast",{event:"new_message"},W=>{const q=W.payload;if(!q||!(q.sender_id===C.id&&q.receiver_id===K||q.sender_id===K&&q.receiver_id===C.id))return;const ee={id:q.id,content:q.content,timestamp:q.created_at,isFromCurrentUser:q.sender_id===C.id};h(L=>{if(L.some(ae=>ae.id===ee.id))return L;const fe=[...L,ee];return b({delay:100}),fe})}).subscribe();return()=>{D.removeChannel(le)}},[s?.id,C?.id]);const _=v=>new Date(v).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"}),t=async()=>{if(!B.trim()||!s||!C||!o)return;const v=T(s.id);if(!v)return;const I=B.trim();z("");try{if(await o(v,I)){const se={id:`temp_${Date.now()}`,content:I,timestamp:new Date().toISOString(),isFromCurrentUser:!0};h(K=>[...K,se]),b({delay:50})}else z(I)}catch{z(I)}},w=v=>{v.key==="Enter"&&!v.shiftKey&&(v.preventDefault(),t())},H=()=>{s&&d&&d({id:s.id,participant:{name:s.participant.name}})},Y=(v,I)=>{f&&f(v,I)};return s?e.jsxs("div",{className:"chat-conversation",children:[!p&&e.jsxs("div",{className:"conversation-header",children:[e.jsxs("div",{className:"conversation-participant",children:[e.jsx(we,{src:s.participant.avatar,name:s.participant.name,alt:`Avatar di ${s.participant.name}`,size:"sm",variant:"default"}),e.jsx("h2",{className:"conversation-participant-name",children:s.participant.name||"Nome non disponibile"})]}),e.jsx("div",{className:"conversation-actions",children:e.jsx(Le,{icon:e.jsx(ca,{}),text:"Elimina",variant:"secondary",onClick:v=>{v.stopPropagation(),v.preventDefault(),H()},className:"delete-chat-action"})})]}),e.jsx("div",{className:"messages-container",children:e.jsxs("div",{className:"messages-list",ref:x,children:[s&&j&&e.jsx("div",{className:"pinned-action-container",children:e.jsx(ba,{participantId:T(s.id),participantName:s.participant.name,onOpenBookingRequest:y,onOpenArtistAppointment:Y})}),s&&g&&c&&$&&e.jsx(Ze,{status:c.status,userType:$.profile_type,appointmentDate:c.appointment_date||void 0,artistName:$.profile_type==="client"?s.participant.name:void 0,clientName:$.profile_type==="artist"?s.participant.name:void 0,artistId:c.artist_id,currentUserId:C?.id,bookingId:c.id,onBookingUpdated:R}),k?e.jsx("div",{className:"loading-messages",children:e.jsx("p",{children:"Caricamento messaggi..."})}):l.length===0?e.jsx("div",{className:"empty-messages",children:e.jsx("p",{children:"Nessun messaggio ancora. Inizia la conversazione!"})}):l.map(v=>{const I=ja(v.content);if(I){const G=I.message_type==="appointment_scheduled"?"appointment":"request";return e.jsx(Ke,{bookingId:I.booking_id,isFromCurrentUser:v.isFromCurrentUser,timestamp:v.timestamp,cardType:G,refreshTrigger:E},v.id)}else return e.jsx("div",{className:`message ${v.isFromCurrentUser?"sent":"received"}`,children:e.jsxs("div",{className:"message-bubble",children:[e.jsx("p",{className:"message-content",children:v.content}),e.jsx("span",{className:"message-time",children:_(v.timestamp)})]})},v.id)})]})}),!p&&e.jsx("div",{className:"message-input-container",children:e.jsxs("div",{className:"message-input-wrapper",children:[e.jsx("textarea",{className:"message-input",placeholder:"Scrivi un messaggio...",value:B,onChange:v=>z(v.target.value),onKeyPress:w,rows:1}),e.jsx(Le,{icon:e.jsx(da,{}),text:"Invia",variant:"secondary",onClick:t,disabled:!B.trim(),className:"send-message-action"})]})})]}):e.jsx("div",{className:"chat-conversation empty",children:e.jsxs("div",{className:"empty-conversation",children:[e.jsx("div",{className:"empty-conversation-icon",children:"💬"}),e.jsx("h3",{className:"empty-conversation-title",children:"Seleziona una conversazione"}),e.jsx("p",{className:"empty-conversation-text",children:"Scegli una chat dalla lista per iniziare a messaggiare"})]})})}const He=(s,d)=>{const o=[s,d].sort();return`${o[0]}__${o[1]}`};function We({clientId:s,clientName:d,onClose:o,onAppointmentCreated:m,existingSubject:p="",sendMessage:y}){const{user:f}=ne(),[A,M]=r.useState(!1),[E,R]=r.useState(!1),[C,$]=r.useState(!1),[B,z]=r.useState({}),[l,h]=r.useState({subject:p,appointment_date:"",appointment_time:"",appointment_duration:"60",deposit_amount:"",total_amount:"",artist_notes:""});r.useEffect(()=>{const c=g=>{const j=g.target;(E||C)&&(j.closest(".custom-dropdown")||(R(!1),$(!1)))};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[E,C]);const k=[{value:"30",label:"30 minuti"},{value:"60",label:"1 ora"},{value:"90",label:"1 ora e 30"},{value:"120",label:"2 ore"},{value:"150",label:"2 ore e 30"},{value:"180",label:"3 ore"},{value:"240",label:"4 ore"},{value:"300",label:"5 ore"},{value:"360",label:"6 ore"}],x=(()=>{const c=[];for(let g=8;g<=20;g++)for(let j=0;j<60;j+=30){const i=`${g.toString().padStart(2,"0")}:${j.toString().padStart(2,"0")}`;c.push({value:i,label:i})}return c})(),S=()=>l.subject.trim()&&l.appointment_date&&l.appointment_time&&l.total_amount&&l.deposit_amount,O=()=>{const c={};if(l.total_amount){const g=parseFloat(l.total_amount);g<=0?c.total_amount="Il prezzo deve essere maggiore di zero":g%10!==0&&(c.total_amount="Il prezzo deve essere un multiplo di 10 (es. 50, 100, 200)")}if(l.deposit_amount){const g=parseFloat(l.deposit_amount);g<=0?c.deposit_amount="L'acconto deve essere maggiore di zero":g%10!==0&&(c.deposit_amount="L'acconto deve essere un multiplo di 10 (es. 50, 100, 200)")}return z(c),Object.keys(c).length===0},T=c=>{B[c]&&z(g=>{const j={...g};return delete j[c],j})},b=async c=>{if(c.preventDefault(),!!f&&!(!S()||!O())){M(!0);try{const g=`${l.appointment_date}T${l.appointment_time}:00`,{data:j,error:i}=await D.from("bookings").select("id").or(`and(client_id.eq.${s},artist_id.eq.${f.id}),and(client_id.eq.${f.id},artist_id.eq.${s})`).eq("status","pending").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(i){console.error("Errore nel recuperare la prenotazione esistente.");return}const _={subject:l.subject,appointment_date:g,appointment_duration:parseInt(l.appointment_duration),deposit_amount:parseFloat(l.deposit_amount),total_amount:parseFloat(l.total_amount),artist_notes:l.artist_notes||null,status:"scheduled"};let t;if(j){const{data:w,error:H}=await D.from("bookings").update(_).eq("id",j.id).select();if(H){console.error("Errore nell'invio dell'appuntamento. Riprova.");return}t=w}else{const w={client_id:s,artist_id:f.id,..._},{data:H,error:Y}=await D.from("bookings").insert([w]).select();if(Y){console.error("Errore nell'invio dell'appuntamento. Riprova.");return}t=H}if(t&&t[0]&&y){const w=JSON.stringify({type:"appointment_scheduled",booking_id:t[0].id});try{await y(s,w)}catch{}}z({}),m&&m(),o()}catch{}finally{M(!1)}}},N=c=>{c.target===c.currentTarget&&(R(!1),$(!1),o())};return e.jsx("div",{className:"modal-overlay",onClick:N,children:e.jsxs("div",{className:"modal-content auth-modal",onClick:c=>c.stopPropagation(),children:[e.jsx("div",{className:"auth-header-sticky",children:e.jsx("button",{className:"modal-close-btn",onClick:o,children:"×"})}),e.jsx("div",{className:"auth-modal-header"}),e.jsxs("div",{className:"auth-content",children:[e.jsxs("div",{className:"header-card",children:[e.jsx("h2",{children:"Crea Appuntamento"}),e.jsxs("p",{children:["Crea un nuovo appuntamento con ",d]})]}),e.jsxs("form",{onSubmit:b,className:"auth-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"subject",className:"form-label",children:["OGGETTO DEL TATUAGGIO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsx("input",{id:"subject",className:"form-input",placeholder:"Es. Rosa con spine, leone, scritta...",maxLength:200,type:"text",value:l.subject,onChange:c=>{h(g=>({...g,subject:c.target.value})),T("subject")}}),B.subject&&e.jsx("div",{className:"form-error",children:B.subject}),e.jsx("div",{className:"form-help",children:p?"Puoi modificare l'oggetto se necessario":"Descrivi il tatuaggio da realizzare"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"appointment_date",className:"form-label",children:["DATA APPUNTAMENTO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsx("input",{id:"appointment_date",className:"form-input",type:"date",min:new Date().toISOString().split("T")[0],value:l.appointment_date,onChange:c=>{h(g=>({...g,appointment_date:c.target.value})),T("appointment_date")}}),B.appointment_date&&e.jsx("div",{className:"form-error",children:B.appointment_date})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["ORARIO APPUNTAMENTO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"custom-dropdown",children:[e.jsxs("button",{type:"button",className:"dropdown-trigger",onClick:()=>{$(!C),R(!1)},children:[e.jsx("span",{className:"dropdown-text",children:l.appointment_time&&x.find(c=>c.value===l.appointment_time)?.label||"Seleziona orario"}),e.jsx("svg",{className:"dropdown-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("polyline",{points:"6,9 12,15 18,9"})})]}),C&&e.jsx("div",{className:"dropdown-menu select-dropdown-menu",children:x.map(c=>e.jsx("button",{type:"button",className:`dropdown-item ${l.appointment_time===c.value?"active":""}`,onClick:()=>{h(g=>({...g,appointment_time:c.value})),$(!1),T("appointment_time")},children:c.label},c.value))})]}),B.appointment_time&&e.jsx("div",{className:"form-error",children:B.appointment_time})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"appointment_duration",className:"form-label",children:"DURATA APPUNTAMENTO"}),e.jsxs("div",{className:"custom-dropdown",children:[e.jsxs("button",{type:"button",className:"dropdown-trigger",onClick:()=>{R(!E),$(!1)},children:[e.jsx("span",{className:"dropdown-text",children:l.appointment_duration&&k.find(c=>c.value===l.appointment_duration)?.label||"Seleziona durata"}),e.jsx("svg",{className:"dropdown-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("polyline",{points:"6,9 12,15 18,9"})})]}),E&&e.jsx("div",{className:"dropdown-menu select-dropdown-menu",children:k.map(c=>e.jsx("button",{type:"button",className:`dropdown-item ${l.appointment_duration===c.value?"active":""}`,onClick:()=>{h(g=>({...g,appointment_duration:c.value})),R(!1)},children:c.label},c.value))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"total_amount",className:"form-label",children:["PREZZO TOTALE TATUAGGIO (€) ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsx("input",{id:"total_amount",className:"form-input",placeholder:"Es. 200",type:"number",min:"10",value:l.total_amount,onChange:c=>{h(g=>({...g,total_amount:c.target.value})),T("total_amount")}}),B.total_amount&&e.jsx("div",{className:"form-error",children:B.total_amount}),e.jsx("div",{className:"form-help",children:"Prezzo totale concordato per il tatuaggio"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"deposit_amount",className:"form-label",children:["ACCONTO RICHIESTO (€) ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsx("input",{id:"deposit_amount",className:"form-input",placeholder:"Es. 50",type:"number",min:"10",value:l.deposit_amount,onChange:c=>{h(g=>({...g,deposit_amount:c.target.value})),T("deposit_amount")}}),B.deposit_amount&&e.jsx("div",{className:"form-error",children:B.deposit_amount}),e.jsx("div",{className:"form-help",children:"Importo dell'acconto richiesto al cliente"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"artist_notes",className:"form-label",children:"NOTE/INDICAZIONI"}),e.jsx("textarea",{id:"artist_notes",className:"form-textarea",placeholder:"Note aggiuntive per il cliente (preparazione, materiali necessari, etc.)",rows:4,maxLength:500,value:l.artist_notes,onChange:c=>h(g=>({...g,artist_notes:c.target.value}))}),e.jsxs("div",{className:"char-count",children:[l.artist_notes.length,"/500 caratteri"]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsxs("button",{type:"button",className:"action-btn",onClick:o,children:[e.jsx("svg",{className:"action-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})}),e.jsx("span",{className:"action-text",children:"Annulla"})]}),e.jsxs("button",{type:"submit",className:"action-btn primary",disabled:A||!S(),children:[e.jsx("svg",{className:"action-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{d:"M20 6L9 17l-5-5"})}),e.jsx("span",{className:"action-text",children:A?"Invio...":"Crea"})]})]})]})]})]})})}function ya(s=768){const[d,o]=r.useState(()=>typeof window>"u"?!1:window.innerWidth<s);return r.useEffect(()=>{const m=()=>{o(window.innerWidth<s)};return m(),window.addEventListener("resize",m),()=>window.removeEventListener("resize",m)},[s]),d}const Ce=r.lazy(()=>fa(()=>import("./index-CRZ081Ij.js").then(s=>s.w),__vite__mapDeps([0,1])).then(s=>({default:s.AuthOverlay})));function Ca({participantId:s,participantName:d,onOpenBookingRequest:o,onOpenArtistAppointment:m}){const{user:p,profile:y}=ne();if(!p||!y||!s)return null;const f=y.profile_type==="artist",A=()=>{if(f){m&&m(s,d);return}o&&o(s)},M=f?"📅":"📝",E=f?"FISSA APPUNTAMENTO":"INVIA UNA RICHIESTA";return e.jsxs("button",{className:"pinned-action-btn",onClick:A,children:[e.jsx("span",{className:"progress-icon",children:M}),e.jsx("span",{className:"progress-text",children:E})]})}const wa=s=>{try{const d=JSON.parse(s);if((d.type==="booking_request"||d.type==="appointment_scheduled")&&d.booking_id)return{booking_id:d.booking_id,message_type:d.type}}catch{return null}return null};function Ea(){const{artistId:s}=ma(),d=ua(),{user:o,profile:m}=ne(),p=ya(),y=()=>d("/"),[f,A]=r.useState(!1),[M,E]=r.useState(!1),[R,C]=r.useState(!1),[$,B]=r.useState(null),[z,l]=r.useState(null),[h,k]=r.useState(null),[u,x]=r.useState(null),[S,O]=r.useState(null),[T,b]=r.useState(0),N=async()=>{b(a=>a+1),h&&await h(),u&&await u()},c=p&&s?s:null,{bookingData:g,showProgressTracker:j,showPinnedAction:i,refreshBookingStatus:_}=Qe(c);r.useEffect(()=>{x(p&&s?()=>_:null)},[_,p,s]);const[t,w]=r.useState({subject:"",tattoo_style:"",body_area:"",size_category:"",color_preferences:"",meaning:"",budget_min:"",budget_max:""}),[H,Y]=r.useState(null),[v,I]=r.useState(null),[G,se]=r.useState(!1),K=async a=>{if(!o?.id)throw new Error("User not authenticated");try{se(!0);const n=a.name.split(".").pop(),P=`booking-ref-${Date.now()}-${Math.random().toString(36).substring(2)}.${n}`,F=`${o.id}/${P}`,{error:V}=await D.storage.from("portfolio").upload(F,a,{cacheControl:"3600",upsert:!1});if(V)throw V;const{data:J}=D.storage.from("portfolio").getPublicUrl(F);return J.publicUrl}catch{throw new Error("Errore durante il caricamento dell'immagine di riferimento")}finally{se(!1)}},[le,W]=r.useState(!1),[q,X]=r.useState(!1),[ee,L]=r.useState(!1),fe=a=>{const n=a.target.files?.[0];if(n){if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(n.type)){alert("Formato file non supportato. Usa JPG, PNG o WebP.");return}if(n.size>5*1024*1024){alert("Il file è troppo grande. Dimensione massima: 5MB.");return}Y(n);const F=new FileReader;F.onload=V=>I(V.target?.result),F.readAsDataURL(n)}},ae=()=>{E(!1),w({subject:"",tattoo_style:"",body_area:"",size_category:"",color_preferences:"",meaning:"",budget_min:"",budget_max:""}),Y(null),I(null),W(!1),X(!1),L(!1)},Me=(a,n)=>{l({id:a,name:n}),C(!0)},Ie=()=>{C(!1),l(null)},Oe=async()=>{h&&await h(),u&&await u(),p&&s?setTimeout(async()=>{const n=(await ue(s)).map(P=>({id:P.id,content:P.content,timestamp:P.created_at,isFromCurrentUser:P.sender_id===o?.id}));ce(n),setTimeout(()=>te(),100)},500):S&&setTimeout(()=>S(),500)},De=async a=>{if(a.preventDefault(),!o||!$){alert("Errore: impossibile inviare richiesta");return}if(!t.subject||!t.tattoo_style||!t.body_area||!t.size_category||!t.color_preferences){alert("Compila tutti i campi obbligatori");return}try{let n=null;if(H)try{n=await K(H)}catch{alert("Errore nel caricamento dell'immagine di riferimento. La richiesta sarà inviata senza immagine.")}const P={client_id:o.id,artist_id:$,subject:t.subject,tattoo_style:t.tattoo_style,body_area:t.body_area,size_category:t.size_category,color_preferences:t.color_preferences,meaning:t.meaning||null,budget_min:t.budget_min?parseFloat(t.budget_min):null,budget_max:t.budget_max?parseFloat(t.budget_max):null,status:"pending",reference_images:n?[n]:null},{data:F,error:V}=await D.from("bookings").insert([P]).select();if(V){alert("Errore nell'invio della richiesta. Riprova.");return}const J=JSON.stringify({type:"booking_request",booking_id:F[0].id});de&&await de($,J),ae(),h&&await h(),u&&await u(),p&&s?setTimeout(async()=>{const Te=(await ue(s)).map(Ne=>({id:Ne.id,content:Ne.content,timestamp:Ne.created_at,isFromCurrentUser:Ne.sender_id===o?.id}));ce(Te),setTimeout(()=>te(),100)},500):S&&setTimeout(()=>S(),500)}catch{alert("Errore nell'invio della richiesta. Riprova.")}},he=[{value:"Tradizionale",label:"Tradizionale"},{value:"Realismo",label:"Realismo"},{value:"Neo-tradizionale",label:"Neo-tradizionale"},{value:"Blackwork",label:"Blackwork"},{value:"Dotwork",label:"Dotwork"},{value:"Geometrico",label:"Geometrico"},{value:"Minimalista",label:"Minimalista"},{value:"Watercolor",label:"Watercolor"},{value:"Biomeccanico",label:"Biomeccanico"},{value:"Tribale",label:"Tribale"},{value:"Giapponese",label:"Giapponese"},{value:"Chicano",label:"Chicano"},{value:"New School",label:"New School"},{value:"Fine Line",label:"Fine Line"},{value:"Lettering",label:"Lettering"},{value:"Altro",label:"Altro"}],ge=[{value:"braccio",label:"Braccio"},{value:"gamba",label:"Gamba"},{value:"schiena",label:"Schiena"},{value:"petto",label:"Petto"},{value:"mano",label:"Mano"},{value:"piede",label:"Piede"},{value:"collo",label:"Collo"},{value:"viso",label:"Viso"},{value:"altro",label:"Altro"}],xe=[{value:"piccolo",label:"Piccolo (2-5cm)"},{value:"medio",label:"Medio (5-15cm)"},{value:"grande",label:"Grande (15-30cm)"},{value:"extra-grande",label:"Extra Grande (>30cm)"}],Ye=a=>{const n=new Date(a),F=(new Date().getTime()-n.getTime())/(1e3*60*60);return F<24?n.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"}):F<48?"Ieri":n.toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit"})},ea=r.useCallback(()=>{A(!0)},[]),aa=r.useCallback(a=>{k(()=>a)},[]),sa=r.useCallback(a=>{O(()=>a)},[]),[Z,oe]=r.useState(null),[ie,me]=r.useState(null),[Q,ke]=r.useState(null),[ve,_e]=r.useState(""),[ze,ce]=r.useState([]),[ta,Pe]=r.useState(!1),{conversations:re,loading:na,error:$e,deleteConversation:ia,markConversationAsRead:ra,sendMessage:de,fetchConversationMessages:ue}=xa(),Be=r.useRef(null),te=r.useCallback(Xe(Be),[]),je=re.map(a=>({id:a.id,participant:{name:a.participant.name,avatar:a.participant.avatar},lastMessage:a.lastMessage,timestamp:a.timestamp,unreadCount:a.unreadCount})),Fe=r.useCallback(async a=>{try{const{data:n,error:P}=await D.from("profiles").select("user_id, full_name, username, avatar_url, profile_type").eq("user_id",a).single();if(P)return;const F={id:a,name:n?.profile_type==="client"?n?.full_name||"Unknown User":n?.username||n?.full_name||"Unknown Artist",avatar:n?.avatar_url};if(o){const V=He(o.id,a);oe(V),me(F)}}catch{}},[o]);r.useEffect(()=>{if(s&&o){const a=He(o.id,s);re.find(P=>P.id===a)?(oe(a),me(null)):Fe(s)}else!s&&p&&(oe(null),me(null))},[s,o,re,Fe,p]),r.useEffect(()=>{Z&&ie&&re.find(n=>n.id===Z)&&me(null)},[re,Z,ie]),r.useEffect(()=>{if(!p||!s||!o||!ue)return;(async(P=!0)=>{P&&Pe(!0);try{const V=(await ue(s)).map(J=>({id:J.id,content:J.content,timestamp:J.created_at,isFromCurrentUser:J.sender_id===o?.id}));ce(V),te({delay:150})}catch{ce([])}finally{P&&Pe(!1)}})(!0);const n=D.channel("global-messages").on("broadcast",{event:"new_message"},P=>{const F=P.payload;if(!F||F.receiver_id!==o.id||F.sender_id!==s)return;const V={id:F.id,content:F.content,timestamp:F.created_at,isFromCurrentUser:F.sender_id===o.id};ce(J=>{if(J.some(Te=>Te.id===V.id))return J;const qe=[...J,V];return te({delay:100}),qe})}).subscribe();return()=>{D.removeChannel(n)}},[p,s,o?.id,te]);const la=a=>new Date(a).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});let U=Z?je.find(a=>a.id===Z):null;r.useEffect(()=>{Z&&!U&&!ie&&oe(null)},[Z,U,ie]),!U&&ie&&Z&&(U={id:Z,participant:{name:ie.name,avatar:ie.avatar},lastMessage:"",timestamp:new Date().toISOString(),unreadCount:0}),r.useEffect(()=>{p&&s&&U&&te({delay:200})},[p,s,U?.id,te]);const Re=a=>{const n=re.find(P=>P.id===a);if(n&&n.unreadCount>0&&ra(n.participant.user_id),p&&n){d(`/messages/${n.participant.user_id}`);return}oe(a)},be=a=>{setTimeout(()=>{ke({id:a.id,participantName:a.participant.name})},0)},Se=async()=>{if(Q)try{const a=re.find(n=>n.id===Q.id);a&&(Z===Q.id&&(oe(null),me(null)),await ia(a.participant.user_id))}catch{}ke(null)},Ae=()=>{ke(null)},Ue=async()=>{if(!ve.trim()||!o)return;let a;if(U){const[P,F]=U.id.split("__");a=P===o.id?F:P}else if(s)a=s;else return;const n=ve.trim();_e("");try{if(await de(a,n)){if(p){const F={id:`temp_${Date.now()}`,content:n,timestamp:new Date().toISOString(),isFromCurrentUser:!0};ce(V=>{const J=[...V,F];return te({delay:50}),J})}}else _e(n)}catch{_e(n)}},oa=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),Ue())};return o?na?e.jsxs("div",{className:"messages-page",children:[e.jsx(ye,{onLogoClick:y,hideOnMobile:!0}),e.jsx("div",{className:"messages-loading",children:e.jsx(pa,{})})]}):$e?e.jsxs("div",{className:"messages-page",children:[e.jsx(ye,{onLogoClick:y,hideOnMobile:!0}),e.jsx("div",{className:"messages-layout",children:e.jsxs("div",{className:"error-message",children:[e.jsx("h3",{children:"Errore caricamento messaggi"}),e.jsx("p",{children:$e})]})})]}):p?s&&U?e.jsxs("div",{className:"messages-page mobile conversation",children:[e.jsxs("div",{className:"mobile-conversation-container",children:[e.jsxs("div",{className:"conversation-header",children:[e.jsx("button",{className:"back-to-messages",onClick:()=>d("/messages"),children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1",children:e.jsx("polyline",{points:"15,18 9,12 15,6"})})}),e.jsxs("div",{className:"conversation-participant",children:[e.jsx(we,{src:U.participant.avatar,name:U.participant.name,alt:`Avatar di ${U.participant.name}`,size:"sm",variant:"default"}),e.jsx("span",{className:"conversation-participant-name",children:U.participant.name})]}),e.jsxs("button",{className:"action-btn delete-chat-action",onClick:()=>be({id:U.id,participant:{name:U.participant.name}}),title:"Elimina conversazione","aria-label":"Elimina conversazione",children:[e.jsx("span",{className:"action-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("polyline",{points:"3,6 5,6 21,6"}),e.jsx("path",{d:"m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"}),e.jsx("line",{x1:"10",y1:"11",x2:"10",y2:"17"}),e.jsx("line",{x1:"14",y1:"11",x2:"14",y2:"17"})]})}),e.jsx("span",{className:"action-text",children:"Elimina"})]})]}),i&&e.jsx("div",{className:"pinned-action-container",children:e.jsx(Ca,{participantId:s,participantName:U.participant.name,onOpenBookingRequest:a=>{a&&(B(a),E(!0))},onOpenArtistAppointment:Me})}),j&&g&&m&&e.jsx(Ze,{status:g.status,userType:m.profile_type,appointmentDate:g.appointment_date||void 0,artistName:m.profile_type==="client"?U?.participant?.name:void 0,clientName:m.profile_type==="artist"?U?.participant?.name:void 0,artistId:m.profile_type==="client"?(()=>{if(!U||!o)return;const[a,n]=U.id.split("__");return a===o.id?n:a})():o?.id,currentUserId:o?.id,bookingId:g.id,onBookingUpdated:N}),e.jsx("div",{className:"messages-list",ref:Be,children:ta?e.jsx("div",{className:"loading-messages",children:e.jsx("p",{children:"Caricamento messaggi..."})}):ze.length===0?e.jsx("div",{className:"empty-messages",children:e.jsx("p",{children:"Nessun messaggio ancora. Inizia la conversazione!"})}):e.jsxs(e.Fragment,{children:[ze.map(a=>{const n=wa(a.content);if(n){const P=n.message_type==="appointment_scheduled"?"appointment":"request";return e.jsx(Ke,{bookingId:n.booking_id,isFromCurrentUser:a.isFromCurrentUser,timestamp:a.timestamp,cardType:P,refreshTrigger:T},a.id)}else return e.jsx("div",{className:`message ${a.isFromCurrentUser?"sent":"received"}`,children:e.jsxs("div",{className:"message-bubble",children:[e.jsx("p",{className:"message-content",children:a.content}),e.jsx("span",{className:"message-time",children:la(a.timestamp)})]})},a.id)}),e.jsx("div",{id:"messages-bottom",style:{height:"1px",minHeight:"1px"}})]})}),e.jsx("div",{className:"message-input-container",children:e.jsxs("div",{className:"message-input-wrapper",children:[e.jsx("textarea",{className:"message-input",placeholder:"Scrivi un messaggio...",value:ve,onChange:a=>_e(a.target.value),onKeyPress:oa,rows:1}),e.jsx("button",{className:"send-message-btn",onClick:Ue,disabled:!ve.trim(),"aria-label":"Invia messaggio",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),e.jsx("polygon",{points:"22,2 15,22 11,13 2,9 22,2"})]})})]})})]}),e.jsx(Ee,{isOpen:Q!==null,title:"Elimina Conversazione",message:Q?`Vuoi davvero eliminare la conversazione con ${Q.participantName}? Questa azione non può essere annullata.`:"",confirmText:"Elimina",cancelText:"Annulla",onConfirm:Se,onCancel:Ae}),f&&e.jsx(r.Suspense,{fallback:e.jsx("div",{}),children:e.jsx(Ce,{isOpen:f,onClose:()=>A(!1)})}),M&&m?.profile_type==="client"&&e.jsx("div",{className:"modal-overlay",onClick:ae,children:e.jsxs("div",{className:"modal-content auth-modal",onClick:a=>a.stopPropagation(),children:[e.jsx("div",{className:"auth-header-sticky",children:e.jsx("button",{className:"modal-close-btn",onClick:ae,children:"×"})}),e.jsx("div",{className:"auth-modal-header"}),e.jsxs("div",{className:"auth-content",children:[e.jsxs("div",{className:"header-card",children:[e.jsx("h2",{children:"RICHIESTA TATUAGGIO"}),e.jsx("p",{children:"Invia una richiesta personalizzata all'artista"})]}),e.jsxs("form",{className:"auth-form",onSubmit:De,children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"subject",className:"form-label",children:["SOGGETTO DEL TATUAGGIO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsx("input",{id:"subject",className:"form-input",placeholder:"Es. Rosa con spine, leone, scritta...",maxLength:200,type:"text",value:t.subject,onChange:a=>w(n=>({...n,subject:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["STILE TATTOO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"custom-dropdown",children:[e.jsxs("button",{type:"button",className:"dropdown-trigger",onClick:()=>W(!le),children:[e.jsx("span",{className:"dropdown-text",children:t.tattoo_style&&he.find(a=>a.value===t.tattoo_style)?.label||"Seleziona uno stile"}),e.jsx("svg",{className:"dropdown-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("polyline",{points:"6,9 12,15 18,9"})})]}),le&&e.jsxs("div",{className:"dropdown-menu select-dropdown-menu",children:[e.jsx("button",{type:"button",className:"dropdown-item",onClick:()=>{w(a=>({...a,tattoo_style:""})),W(!1)},children:"Seleziona uno stile"}),he.map(a=>e.jsx("button",{type:"button",className:`dropdown-item ${t.tattoo_style===a.value?"active":""}`,onClick:()=>{w(n=>({...n,tattoo_style:a.value})),W(!1)},children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["ZONA DEL CORPO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"custom-dropdown",children:[e.jsxs("button",{type:"button",className:"dropdown-trigger",onClick:()=>X(!q),children:[e.jsx("span",{className:"dropdown-text",children:t.body_area&&ge.find(a=>a.value===t.body_area)?.label||"Seleziona una zona"}),e.jsx("svg",{className:"dropdown-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("polyline",{points:"6,9 12,15 18,9"})})]}),q&&e.jsxs("div",{className:"dropdown-menu select-dropdown-menu",children:[e.jsx("button",{type:"button",className:"dropdown-item",onClick:()=>{w(a=>({...a,body_area:""})),X(!1)},children:"Seleziona una zona"}),ge.map(a=>e.jsx("button",{type:"button",className:`dropdown-item ${t.body_area===a.value?"active":""}`,onClick:()=>{w(n=>({...n,body_area:a.value})),X(!1)},children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["DIMENSIONI ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"custom-dropdown",children:[e.jsxs("button",{type:"button",className:"dropdown-trigger",onClick:()=>L(!ee),children:[e.jsx("span",{className:"dropdown-text",children:t.size_category&&xe.find(a=>a.value===t.size_category)?.label||"Seleziona una dimensione"}),e.jsx("svg",{className:"dropdown-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("polyline",{points:"6,9 12,15 18,9"})})]}),ee&&e.jsxs("div",{className:"dropdown-menu select-dropdown-menu",children:[e.jsx("button",{type:"button",className:"dropdown-item",onClick:()=>{w(a=>({...a,size_category:""})),L(!1)},children:"Seleziona una dimensione"}),xe.map(a=>e.jsx("button",{type:"button",className:`dropdown-item ${t.size_category===a.value?"active":""}`,onClick:()=>{w(n=>({...n,size_category:a.value})),L(!1)},children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["COLORE ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"radio-group",children:[e.jsxs("label",{className:"radio-option",children:[e.jsx("input",{type:"radio",name:"color_preferences",value:"Bianco e nero",checked:t.color_preferences==="Bianco e nero",onChange:a=>w(n=>({...n,color_preferences:a.target.value}))}),e.jsx("span",{className:"radio-label",children:"Bianco e nero"})]}),e.jsxs("label",{className:"radio-option",children:[e.jsx("input",{type:"radio",name:"color_preferences",value:"Colori",checked:t.color_preferences==="Colori",onChange:a=>w(n=>({...n,color_preferences:a.target.value}))}),e.jsx("span",{className:"radio-label",children:"Colori"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"meaning",className:"form-label",children:"SIGNIFICATO EVENTUALE"}),e.jsx("textarea",{id:"meaning",className:"form-textarea",placeholder:"Racconta il significato del tuo tatuaggio (opzionale)",rows:3,maxLength:500,value:t.meaning,onChange:a=>w(n=>({...n,meaning:a.target.value}))}),e.jsxs("div",{className:"char-count",children:[t.meaning.length,"/500 caratteri"]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"reference_images",className:"form-label",children:"IMMAGINI DI RIFERIMENTO"}),e.jsxs("div",{className:"image-upload-section",children:[v&&e.jsxs("div",{className:"image-preview-container",children:[e.jsx("img",{src:v,alt:"Preview",className:"image-preview"}),e.jsx("button",{type:"button",className:"remove-image-btn",onClick:()=>{Y(null),I(null)},children:"×"})]}),e.jsxs("div",{className:"file-upload-container",children:[e.jsx("input",{id:"reference_images",className:"file-input",accept:"image/jpeg,image/jpg,image/png,image/webp",type:"file",onChange:fe}),e.jsxs("label",{htmlFor:"reference_images",className:"file-upload-btn",children:[e.jsx("svg",{className:"upload-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})}),e.jsx("span",{children:H?"Cambia Immagine":"Carica Immagine"})]})]}),e.jsx("p",{className:"file-info",children:"JPG, PNG o WebP. Max 5MB."})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"budget_min",className:"form-label",children:["BUDGET (€) ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("input",{id:"budget_min",className:"form-input",placeholder:"Min",type:"number",min:"0",step:"10",value:t.budget_min,onChange:a=>w(n=>({...n,budget_min:a.target.value})),required:!0}),e.jsx("span",{className:"budget-separator",children:"-"}),e.jsx("input",{id:"budget_max",className:"form-input",placeholder:"Max",type:"number",min:"0",step:"10",value:t.budget_max,onChange:a=>w(n=>({...n,budget_max:a.target.value})),required:!0})]}),e.jsx("div",{className:"form-help",children:"Indica il range di budget che hai in mente"})]}),e.jsxs("div",{className:"form-actions",children:[e.jsxs("button",{type:"button",className:"action-btn",onClick:ae,children:[e.jsx("svg",{className:"action-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})}),e.jsx("span",{className:"action-text",children:"Annulla"})]}),e.jsxs("button",{type:"submit",className:`action-btn ${G?"disabled":""}`,disabled:G||!t.subject.trim()||!t.tattoo_style||!t.body_area||!t.size_category||!t.color_preferences||!t.budget_min||!t.budget_max,children:[e.jsx("svg",{className:"action-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{d:"M12 5v14m7-7l-7-7-7 7"})}),e.jsx("span",{className:"action-text",children:G?"Caricamento...":"Invia"})]})]})]})]})]})}),R&&z&&e.jsx(We,{clientId:z.id,clientName:z.name,onClose:Ie,onAppointmentCreated:Oe,sendMessage:de})]}):e.jsxs("div",{className:"messages-page mobile",children:[e.jsxs("div",{className:"mobile-messages-container",children:[e.jsx("div",{className:"chat-list-header",children:e.jsx("h1",{className:"chat-list-title",children:"Messaggi"})}),e.jsx("div",{className:"chat-list-items",children:je.length===0?e.jsx(Ge,{icon:"💬",title:"Nessun messaggio",description:"Non hai ancora conversazioni attive."}):je.map(a=>e.jsxs("div",{className:`chat-item ${Z===a.id?"active":""}`,onClick:()=>Re(a.id),children:[e.jsx("div",{className:"chat-avatar",children:e.jsx(we,{src:a.participant.avatar,name:a.participant.name,alt:`Avatar di ${a.participant.name}`,size:"sm",variant:"default"})}),e.jsxs("div",{className:"chat-content",children:[e.jsxs("div",{className:"chat-header",children:[e.jsx("h3",{className:"chat-list-participant-name",children:a.participant.name}),e.jsxs("div",{className:"chat-header-actions",children:[e.jsx("span",{className:"chat-timestamp",children:Ye(a.timestamp)}),e.jsx("button",{className:"chat-delete-btn",onClick:n=>{n.stopPropagation(),be({id:a.id,participant:{name:a.participant.name}})},title:"Elimina conversazione","aria-label":"Elimina conversazione",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("polyline",{points:"3,6 5,6 21,6"}),e.jsx("path",{d:"m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"})]})})]})]}),e.jsxs("div",{className:"chat-preview",children:[e.jsx("p",{className:"chat-last-message",children:a.lastMessage||"Inizia una conversazione"}),a.unreadCount>0&&e.jsx("span",{className:"chat-unread-count",children:a.unreadCount})]})]})]},a.id))})]}),e.jsx(Ee,{isOpen:Q!==null,title:"Elimina Conversazione",message:Q?`Vuoi davvero eliminare la conversazione con ${Q.participantName}? Questa azione non può essere annullata.`:"",confirmText:"Elimina",cancelText:"Annulla",onConfirm:Se,onCancel:Ae}),f&&e.jsx(r.Suspense,{fallback:e.jsx("div",{}),children:e.jsx(Ce,{isOpen:f,onClose:()=>A(!1)})})]}):e.jsxs("div",{className:`messages-page ${M?"modal-open":""}`,children:[e.jsx(ye,{onLogoClick:y,hideOnMobile:!0}),e.jsxs("div",{className:"messages-layout",children:[e.jsx("div",{className:"chat-list-section",children:e.jsx(ga,{chats:je,selectedChatId:Z,onChatSelect:Re,onRequestDeleteChat:be})}),e.jsx("div",{className:"chat-conversation-section",children:U?e.jsx(Na,{chat:U,onRequestDeleteChat:be,sendMessage:de,fetchConversationMessages:ue,isModalOpen:M,onOpenBookingRequest:a=>{a&&(B(a),E(!0))},onBookingRequestSent:()=>{},onOpenArtistAppointment:Me,onBookingStatusRefresh:aa,onMessagesRefresh:sa,refreshTrigger:T,onBookingUpdated:N}):e.jsx("div",{className:"chat-conversation empty",children:e.jsxs("div",{className:"empty-conversation",children:[e.jsx("div",{className:"empty-conversation-icon",children:"💬"}),e.jsx("h3",{className:"empty-conversation-title",children:"Seleziona una conversazione"}),e.jsx("p",{className:"empty-conversation-text",children:"Scegli una chat dalla lista per iniziare a messaggiare"})]})})})]}),e.jsx(Ee,{isOpen:Q!==null,title:"Elimina Conversazione",message:Q?`Vuoi davvero eliminare la conversazione con ${Q.participantName}? Questa azione non può essere annullata.`:"",confirmText:"Elimina",cancelText:"Annulla",onConfirm:Se,onCancel:Ae}),f&&e.jsx(r.Suspense,{fallback:e.jsx("div",{}),children:e.jsx(Ce,{isOpen:f,onClose:()=>A(!1)})}),M&&m?.profile_type==="client"&&e.jsx("div",{className:"modal-overlay",onClick:ae,children:e.jsxs("div",{className:"modal-content auth-modal",onClick:a=>a.stopPropagation(),children:[e.jsx("div",{className:"auth-header-sticky",children:e.jsx("button",{className:"modal-close-btn",onClick:ae,children:"×"})}),e.jsx("div",{className:"auth-modal-header"}),e.jsxs("div",{className:"auth-content",children:[e.jsxs("div",{className:"header-card",children:[e.jsx("h2",{children:"RICHIESTA TATUAGGIO"}),e.jsx("p",{children:"Invia una richiesta personalizzata all'artista"})]}),e.jsxs("form",{className:"auth-form",onSubmit:De,children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"subject",className:"form-label",children:["SOGGETTO DEL TATUAGGIO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsx("input",{id:"subject",className:"form-input",placeholder:"Es. Rosa con spine, leone, scritta...",maxLength:200,type:"text",value:t.subject,onChange:a=>w(n=>({...n,subject:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["STILE TATTOO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"custom-dropdown",children:[e.jsxs("button",{type:"button",className:"dropdown-trigger",onClick:()=>W(!le),children:[e.jsx("span",{className:"dropdown-text",children:t.tattoo_style&&he.find(a=>a.value===t.tattoo_style)?.label||"Seleziona uno stile"}),e.jsx("svg",{className:"dropdown-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("polyline",{points:"6,9 12,15 18,9"})})]}),le&&e.jsxs("div",{className:"dropdown-menu select-dropdown-menu",children:[e.jsx("button",{type:"button",className:"dropdown-item",onClick:()=>{w(a=>({...a,tattoo_style:""})),W(!1)},children:"Seleziona uno stile"}),he.map(a=>e.jsx("button",{type:"button",className:`dropdown-item ${t.tattoo_style===a.value?"active":""}`,onClick:()=>{w(n=>({...n,tattoo_style:a.value})),W(!1)},children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["ZONA DEL CORPO ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"custom-dropdown",children:[e.jsxs("button",{type:"button",className:"dropdown-trigger",onClick:()=>X(!q),children:[e.jsx("span",{className:"dropdown-text",children:t.body_area&&ge.find(a=>a.value===t.body_area)?.label||"Seleziona una zona"}),e.jsx("svg",{className:"dropdown-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("polyline",{points:"6,9 12,15 18,9"})})]}),q&&e.jsxs("div",{className:"dropdown-menu select-dropdown-menu",children:[e.jsx("button",{type:"button",className:"dropdown-item",onClick:()=>{w(a=>({...a,body_area:""})),X(!1)},children:"Seleziona una zona"}),ge.map(a=>e.jsx("button",{type:"button",className:`dropdown-item ${t.body_area===a.value?"active":""}`,onClick:()=>{w(n=>({...n,body_area:a.value})),X(!1)},children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["DIMENSIONI ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"custom-dropdown",children:[e.jsxs("button",{type:"button",className:"dropdown-trigger",onClick:()=>L(!ee),children:[e.jsx("span",{className:"dropdown-text",children:t.size_category&&xe.find(a=>a.value===t.size_category)?.label||"Seleziona una dimensione"}),e.jsx("svg",{className:"dropdown-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("polyline",{points:"6,9 12,15 18,9"})})]}),ee&&e.jsxs("div",{className:"dropdown-menu select-dropdown-menu",children:[e.jsx("button",{type:"button",className:"dropdown-item",onClick:()=>{w(a=>({...a,size_category:""})),L(!1)},children:"Seleziona una dimensione"}),xe.map(a=>e.jsx("button",{type:"button",className:`dropdown-item ${t.size_category===a.value?"active":""}`,onClick:()=>{w(n=>({...n,size_category:a.value})),L(!1)},children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{className:"form-label",children:["COLORE ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"radio-group",children:[e.jsxs("label",{className:"radio-option",children:[e.jsx("input",{type:"radio",name:"color_preferences",value:"Bianco e nero",checked:t.color_preferences==="Bianco e nero",onChange:a=>w(n=>({...n,color_preferences:a.target.value}))}),e.jsx("span",{className:"radio-label",children:"Bianco e nero"})]}),e.jsxs("label",{className:"radio-option",children:[e.jsx("input",{type:"radio",name:"color_preferences",value:"Colori",checked:t.color_preferences==="Colori",onChange:a=>w(n=>({...n,color_preferences:a.target.value}))}),e.jsx("span",{className:"radio-label",children:"Colori"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"meaning",className:"form-label",children:"SIGNIFICATO EVENTUALE"}),e.jsx("textarea",{id:"meaning",className:"form-textarea",placeholder:"Racconta il significato del tuo tatuaggio (opzionale)",rows:3,maxLength:500,value:t.meaning,onChange:a=>w(n=>({...n,meaning:a.target.value}))}),e.jsxs("div",{className:"char-count",children:[t.meaning.length,"/500 caratteri"]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"reference_images",className:"form-label",children:"IMMAGINI DI RIFERIMENTO"}),e.jsxs("div",{className:"image-upload-section",children:[v&&e.jsxs("div",{className:"image-preview-container",children:[e.jsx("img",{src:v,alt:"Preview",className:"image-preview"}),e.jsx("button",{type:"button",className:"remove-image-btn",onClick:()=>{Y(null),I(null)},children:"×"})]}),e.jsxs("div",{className:"file-upload-container",children:[e.jsx("input",{id:"reference_images",className:"file-input",accept:"image/jpeg,image/jpg,image/png,image/webp",type:"file",onChange:fe}),e.jsxs("label",{htmlFor:"reference_images",className:"file-upload-btn",children:[e.jsx("svg",{className:"upload-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})}),e.jsx("span",{children:H?"Cambia Immagine":"Carica Immagine"})]})]}),e.jsx("p",{className:"file-info",children:"JPG, PNG o WebP. Max 5MB."})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"budget_min",className:"form-label",children:["BUDGET (€) ",e.jsx("span",{className:"required-indicator",children:"*"})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("input",{id:"budget_min",className:"form-input",placeholder:"Min",type:"number",min:"0",step:"10",value:t.budget_min,onChange:a=>w(n=>({...n,budget_min:a.target.value})),required:!0}),e.jsx("span",{className:"budget-separator",children:"-"}),e.jsx("input",{id:"budget_max",className:"form-input",placeholder:"Max",type:"number",min:"0",step:"10",value:t.budget_max,onChange:a=>w(n=>({...n,budget_max:a.target.value})),required:!0})]}),e.jsx("div",{className:"form-help",children:"Indica il range di budget che hai in mente"})]}),e.jsxs("div",{className:"form-actions",children:[e.jsxs("button",{type:"button",className:"action-btn",onClick:ae,children:[e.jsx("svg",{className:"action-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})}),e.jsx("span",{className:"action-text",children:"Annulla"})]}),e.jsxs("button",{type:"submit",className:"action-btn",disabled:!t.subject.trim()||!t.tattoo_style||!t.body_area||!t.size_category||!t.color_preferences||!t.budget_min||!t.budget_max,children:[e.jsx("svg",{className:"action-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{d:"M12 5v14m7-7l-7-7-7 7"})}),e.jsx("span",{className:"action-text",children:"Invia"})]})]})]})]})]})}),R&&z&&e.jsx(We,{clientId:z.id,clientName:z.name,onClose:Ie,onAppointmentCreated:Oe,sendMessage:de})]}):e.jsxs("div",{className:"messages-page",children:[e.jsx(ye,{onLogoClick:y,hideOnMobile:!0}),e.jsx("div",{className:"container",children:e.jsx(Ge,{icon:"💬",title:"Accedi per visualizzare i messaggi",description:"Effettua il login per vedere le tue conversazioni e iniziare a chattare con gli artisti.",action:e.jsx("button",{className:"action-btn",onClick:ea,style:{marginTop:"1.5rem"},children:"Accedi"})})}),f&&e.jsx(r.Suspense,{fallback:e.jsx("div",{}),children:e.jsx(Ce,{isOpen:f,onClose:()=>A(!1)})})]})}export{Ea as MessagesPage};
