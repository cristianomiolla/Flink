import{r as o,j as e,b as E,s as j,t as p}from"./index-CRZ081Ij.js";function y({isOpen:s,initialFormData:r,resetDependencies:n=[]}){const[a,l]=o.useState(r),[t,c]=o.useState({}),[d,h]=o.useState(!1),[v,m]=o.useState("");o.useEffect(()=>{s||(l(r),c({}),m(""),h(!1))},[s,r,...n]);const f=o.useCallback((i,u)=>{l(g=>({...g,[i]:u})),t[i]&&c(g=>{const x={...g};return delete x[i],x})},[t]),b=o.useCallback(i=>{c(i)},[]);return{formData:a,setFormData:l,errors:t,isSubmitting:d,setIsSubmitting:h,successMessage:v,setSuccessMessage:m,handleInputChange:f,setFormErrors:b}}function N(s,r){return o.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),o.useEffect(()=>{const a=l=>{l.key==="Escape"&&r()};return s&&document.addEventListener("keydown",a),()=>{document.removeEventListener("keydown",a)}},[s,r]),{handleOverlayClick:o.useCallback(a=>{a.target===a.currentTarget&&r()},[r])}}function w({isOpen:s,onClose:r,children:n,title:a,subtitle:l,showHeader:t=!0}){const{handleOverlayClick:c}=N(s,r);return s?e.jsx("div",{className:"modal-overlay",onClick:c,children:e.jsxs("div",{className:"modal-content auth-modal",children:[e.jsx("div",{className:"auth-header-sticky",children:e.jsx("button",{className:"modal-close-btn",onClick:r,children:"×"})}),e.jsx("div",{className:"auth-modal-header"}),e.jsxs("div",{className:"auth-content",children:[t&&(a||l)&&e.jsxs("div",{className:"header-card",children:[a&&e.jsx("h2",{children:a}),l&&e.jsx("p",{children:l})]}),n]})]})}):null}function k({label:s,htmlFor:r,required:n=!1,error:a,children:l,className:t=""}){return e.jsxs("div",{className:`form-group ${t}`,children:[e.jsxs("label",{className:"form-label",htmlFor:r,children:[s," ",n&&e.jsx("span",{className:"required-indicator",children:"*"})]}),l,a&&e.jsx("div",{className:"form-errors",children:Array.isArray(a)?a.map((c,d)=>e.jsx("div",{className:"form-error",children:c},d)):e.jsx("div",{className:"form-error",children:a})})]})}function A({isOpen:s,onClose:r}){const{user:n}=E(),{formData:a,errors:l,isSubmitting:t,setIsSubmitting:c,successMessage:d,setSuccessMessage:h,handleInputChange:v,setFormErrors:m}=y({isOpen:s,initialFormData:{newEmail:""}}),f=()=>{const i={};return a.newEmail?p(a.newEmail)?a.newEmail===n?.email&&(i.newEmail="La nuova email deve essere diversa da quella attuale"):i.newEmail="Email non valida":i.newEmail="Nuova email richiesta",m(i),Object.keys(i).length===0},b=async i=>{if(i.preventDefault(),!!f()&&!(t||!n)){c(!0);try{const{error:u}=await j.auth.updateUser({email:a.newEmail},{emailRedirectTo:"https://cristianomiolla.github.io/Flink/"});if(u){u.message.includes("email_address_taken")?m({newEmail:"Questa email è già utilizzata da un altro account"}):m({general:u.message});return}h("Email di conferma inviata! Controlla sia la VECCHIA che la NUOVA casella postale e clicca sui link di conferma in entrambe per completare il cambio."),setTimeout(()=>{r()},5e3)}catch{m({general:"Si è verificato un errore. Riprova."})}finally{c(!1)}}};return e.jsxs(w,{isOpen:s,onClose:r,title:"CAMBIA EMAIL",subtitle:"Aggiorna l'indirizzo email del tuo account",children:[l.general&&e.jsx("div",{className:"auth-error",children:l.general}),d&&e.jsxs("div",{className:"auth-success",children:[d,e.jsxs("div",{style:{marginTop:"1rem",fontSize:"13px",lineHeight:"1.4"},children:[e.jsx("strong",{children:"IMPORTANTE:"}),e.jsx("br",{}),"• Controlla la tua vecchia email (",n?.email,") e clicca il link di conferma",e.jsx("br",{}),"• Controlla la tua nuova email e clicca il link di conferma",e.jsx("br",{}),"• Solo dopo aver confermato entrambe potrai accedere con la nuova email",e.jsx("br",{}),"• Fino ad allora continuerai ad accedere con la vecchia email",e.jsx("br",{}),"• La sincronizzazione del profilo avverrà automaticamente dopo la conferma"]})]}),e.jsxs("form",{className:"auth-form",onSubmit:b,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Email attuale"}),e.jsx("div",{className:"current-email-display",children:n?.email||"N/A"})]}),e.jsx(k,{label:"Nuova email",htmlFor:"newEmail",required:!0,error:l.newEmail,children:e.jsx("input",{id:"newEmail",type:"email",className:`form-input ${l.newEmail?"error":""}`,value:a.newEmail,onChange:i=>v("newEmail",i.target.value),placeholder:"Inserisci la nuova email",disabled:t})}),e.jsxs("div",{className:"warning-message",style:{background:"rgb(254, 243, 199)",color:"rgb(146, 64, 14)",padding:"1rem",borderRadius:"4px",fontSize:"0.875rem"},children:[e.jsx("strong",{children:"Attenzione:"})," Riceverai due email di conferma: una sulla vecchia email (",n?.email,") e una sulla nuova. Dovrai confermare entrambe per completare il cambio. Fino ad allora continuerai ad accedere con la vecchia email."]}),e.jsx("button",{type:"submit",className:"action-btn",disabled:t||!a.newEmail.trim(),children:t?"Invio in corso...":"Aggiorna Email"})]})]})}export{A as EmailChangeOverlay};
